{% extends "base.html" %}

{% block title %}用户管理{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="bi bi-people"></i> 用户管理</h2>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
        </div>

        <!-- Search Form -->
        <div class="card mb-3">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="user_id" class="form-label">用户ID</label>
                        <input type="text" class="form-control" id="user_id" name="user_id"
                               value="{{ search_user_id }}" placeholder="输入Telegram用户ID">
                    </div>
                    <div class="col-md-4">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" name="username"
                               value="{{ search_username }}" placeholder="输入用户名">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                        <a href="{{ url_for('dashboard_users') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> 清除
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- User Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>用户ID</th>
                                <th>用户名</th>
                                <th>注册时间 (GMT+8)</th>
                                <th>VIP等级</th>
                                <th>积分余额</th>
                                <th>累计消费</th>
                                <th>图片脱衣</th>
                                <th>免费使用</th>
                                <th>图片转视频</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr class="clickable-row" data-user-id="{{ user.user_id }}">
                                <td><code>{{ user.user_id }}</code></td>
                                <td>{{ user.username }}</td>
                                <td><small>{{ user.created_at }}</small></td>
                                <td>
                                    {% if user.vip_tier == 'black_gold' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-gem"></i> {{ user.vip_display }}
                                        </span>
                                    {% elif user.vip_tier == 'vip' %}
                                        <span class="badge bg-primary">
                                            <i class="bi bi-star-fill"></i> {{ user.vip_display }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ user.vip_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.credit_balance }}</td>
                                <td>{{ user.total_spent }}</td>
                                <td><span class="badge bg-info">{{ user.image_count }}</span></td>
                                <td><span class="badge bg-success">{{ user.free_count }}</span></td>
                                <td><span class="badge bg-success">{{ user.video_count }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if users|length == 0 %}
                <div class="alert alert-info text-center mt-3">
                    <i class="bi bi-info-circle"></i> 没有找到用户
                </div>
                {% else %}
                <div class="mt-3 text-muted">
                    <small>共 {{ users|length }} 个用户 | 点击用户行查看交易记录</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Transaction History Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-receipt"></i> 用户交易记录
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transactionLoading" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
                <div id="transactionContent" style="display:none;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>类型</th>
                                <th>金额</th>
                                <th>余额</th>
                                <th>描述</th>
                                <th>时间 (GMT+8)</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle row clicks to show transaction history
document.querySelectorAll('.clickable-row').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function() {
        const userId = this.dataset.userId;
        showUserTransactions(userId);
    });
});

function showUserTransactions(userId) {
    const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
    document.getElementById('transactionLoading').style.display = 'block';
    document.getElementById('transactionContent').style.display = 'none';
    modal.show();

    fetch(`/api/user/${userId}/transactions`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('transactionTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无交易记录</td></tr>';
            } else {
                data.forEach(txn => {
                    const row = document.createElement('tr');
                    const typeClass = txn.type === 'topup' ? 'success' :
                                     txn.type === 'deduction' ? 'danger' : 'warning';

                    row.innerHTML = `
                        <td>${txn.id}</td>
                        <td><span class="badge bg-${typeClass}">${txn.type}</span></td>
                        <td>${txn.amount}</td>
                        <td>${txn.balance_after}</td>
                        <td><small>${txn.description}</small></td>
                        <td><small>${txn.created_at}</small></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            document.getElementById('transactionLoading').style.display = 'none';
            document.getElementById('transactionContent').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('加载交易记录失败');
        });
}
</script>
{% endblock %}
