{% extends "base.html" %}

{% block title %}功能分析{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="bi bi-graph-up"></i> 功能使用分析</h2>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
        </div>

        <!-- Window Controls -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="bi bi-sliders"></i> 时间窗口控制</h5>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <!-- Days control -->
                            <span class="badge bg-secondary">窗口大小:</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="adjustDays(-1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <span class="badge bg-primary fs-6 px-3">{{ window.days }} 天</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="adjustDays(1)">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
                            <!-- Offset control -->
                            <span class="badge bg-secondary">窗口位置:</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="adjustOffset(-1)">
                                <i class="bi bi-arrow-left"></i>
                            </button>
                            <span class="badge bg-secondary fs-6 px-3">偏移 {{ window.offset }} 天</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="adjustOffset(1)">
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <h6 class="text-muted">当前时间范围 (GMT+8)</h6>
                        <h5 class="mb-0">
                            <span class="text-primary">{{ window.start_date }}</span>
                            <i class="bi bi-arrow-right mx-2"></i>
                            <span class="text-success">{{ window.end_date }}</span>
                        </h5>
                        <button class="btn btn-sm btn-warning mt-2" onclick="resetWindow()">
                            <i class="bi bi-arrow-counterclockwise"></i> 重置为最近30天
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-image"></i> 图片脱衣（付费）
                        </h6>
                        <h2 class="mb-0">{{ analytics.image_paid }}</h2>
                        <small>使用次数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-gift"></i> 图片脱衣（免费）
                        </h6>
                        <h2 class="mb-0">{{ analytics.image_free }}</h2>
                        <small>使用次数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-film"></i> 图片转视频（付费）
                        </h6>
                        <h2 class="mb-0">{{ analytics.video_paid }}</h2>
                        <small>使用次数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-gift"></i> 图片转视频（免费）
                        </h6>
                        <h2 class="mb-0">{{ analytics.video_free }}</h2>
                        <small>使用次数</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Cards -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-coin"></i> 图片脱衣收入
                        </h6>
                        <h2 class="mb-0">{{ analytics.image_revenue }}</h2>
                        <small>积分</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-warning">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-currency-dollar"></i> 视频收入
                        </h6>
                        <h2 class="mb-0">{{ analytics.video_revenue }}</h2>
                        <small>积分</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Free Trial Stats -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-gift"></i> 免费试用统计
                        </h5>
                        <p class="mb-0">
                            已使用免费试用的用户: <strong>{{ analytics.free_trial_users }}</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-graph-up-arrow"></i> 功能使用趋势 ({{ window.days }}天)
                        </h5>
                        <canvas id="usageTrendChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-pie-chart"></i> 功能使用分布
                        </h5>
                        <canvas id="featurePopularityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Get window parameters
const currentDays = {{ window.days }};
const currentOffset = {{ window.offset }};

// Usage Trend Chart (Line Chart)
const usageTrendCtx = document.getElementById('usageTrendChart').getContext('2d');
const dailyUsage = {{ analytics.daily_usage | tojson }};

const labels = dailyUsage.map(d => d.date);
const imagePaidData = dailyUsage.map(d => d.image_paid);
const imageFreeData = dailyUsage.map(d => d.image_free);
const videoPaidData = dailyUsage.map(d => d.video_paid);
const videoFreeData = dailyUsage.map(d => d.video_free);

new Chart(usageTrendCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: '图片脱衣（付费）',
                data: imagePaidData,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.1,
                fill: true
            },
            {
                label: '图片脱衣（免费）',
                data: imageFreeData,
                borderColor: 'rgb(23, 162, 184)',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.1,
                fill: true,
                borderDash: [5, 5]
            },
            {
                label: '图片转视频（付费）',
                data: videoPaidData,
                borderColor: 'rgb(40, 167, 69)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.1,
                fill: true
            },
            {
                label: '图片转视频（免费）',
                data: videoFreeData,
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.1,
                fill: true,
                borderDash: [5, 5]
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Feature Popularity Chart (Pie Chart)
const featurePopularityCtx = document.getElementById('featurePopularityChart').getContext('2d');

new Chart(featurePopularityCtx, {
    type: 'pie',
    data: {
        labels: ['图片脱衣（付费）', '图片脱衣（免费）', '图片转视频（付费）', '图片转视频（免费）'],
        datasets: [{
            data: [
                {{ analytics.image_paid }},
                {{ analytics.image_free }},
                {{ analytics.video_paid }},
                {{ analytics.video_free }}
            ],
            backgroundColor: [
                'rgb(54, 162, 235)',   // image paid - blue
                'rgb(23, 162, 184)',   // image free - cyan
                'rgb(40, 167, 69)',    // video paid - green
                'rgb(255, 193, 7)'     // video free - yellow
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Window control functions
function adjustDays(delta) {
    const newDays = currentDays + delta;
    if (newDays < 7 || newDays > 365) {
        alert('窗口天数范围: 7-365天');
        return;
    }
    window.location.href = `?days=${newDays}&offset=${currentOffset}`;
}

function adjustOffset(delta) {
    const newOffset = currentOffset + delta;
    if (newOffset < -1000 || newOffset > 0) {
        alert('最多可查看1000天前的数据');
        return;
    }
    window.location.href = `?days=${currentDays}&offset=${newOffset}`;
}

function resetWindow() {
    window.location.href = '?days=30&offset=0';
}
</script>
{% endblock %}
