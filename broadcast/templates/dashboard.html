{% extends "base.html" %}

{% block title %}发送广播 - 广播门户{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Panel: Filters and Drafts -->
    <div class="col-md-3">
        <!-- User Count -->
        <div class="card mb-3 bg-light">
            <div class="card-body text-center">
                <h5 class="card-title">目标用户</h5>
                <h2 class="mb-0 text-primary" id="userCount">-</h2>
                <small class="text-muted">用户将收到此消息</small>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-funnel"></i> 用户筛选
            </div>
            <div class="card-body">
                <!-- VIP Status Filter -->
                <div class="mb-3">
                    <label class="form-label fw-bold">VIP等级</label>
                    <div class="form-check">
                        <input class="form-check-input filter-checkbox" type="checkbox" id="vip-none" value="none" checked>
                        <label class="form-check-label" for="vip-none">普通用户</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-checkbox" type="checkbox" id="vip-vip" value="vip" checked>
                        <label class="form-check-label" for="vip-vip">VIP用户</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-checkbox" type="checkbox" id="vip-black_gold" value="black_gold" checked>
                        <label class="form-check-label" for="vip-black_gold">黑金VIP</label>
                    </div>
                </div>

                <!-- Credit Balance Filter -->
                <div class="mb-3">
                    <label class="form-label fw-bold">积分余额</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="min-balance" placeholder="最小值">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="max-balance" placeholder="最大值">
                        </div>
                    </div>
                </div>

                <!-- Last Activity Filter -->
                <div class="mb-3">
                    <label class="form-label fw-bold">最后活跃时间</label>
                    <input type="date" class="form-control form-control-sm mb-2" id="last-active-after" placeholder="开始日期">
                    <input type="date" class="form-control form-control-sm" id="last-active-before" placeholder="结束日期">
                </div>

                <!-- Purchase History Filter -->
                <div class="mb-3">
                    <label class="form-label fw-bold">用户类型</label>
                    <select class="form-select form-select-sm" id="purchase-filter">
                        <option value="all" selected>所有用户</option>
                        <option value="paid">付费用户</option>
                        <option value="free">免费用户</option>
                    </select>
                </div>

                <button class="btn btn-sm btn-secondary w-100" onclick="resetFilters()">
                    <i class="bi bi-arrow-counterclockwise"></i> 重置筛选
                </button>
            </div>
        </div>

        <!-- Drafts -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-earmark-text"></i> 草稿箱
            </div>
            <div class="card-body">
                <div id="draftsList" class="list-group list-group-flush">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-inbox"></i><br>
                        暂无草稿
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Middle Panel: Message Editor -->
    <div class="col-md-5">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-pencil-square"></i> 消息编辑器</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" id="markdownBtn" onclick="setParseMode('Markdown')">Markdown</button>
                    <button class="btn btn-outline-primary" id="htmlBtn" onclick="setParseMode('HTML')">HTML</button>
                </div>
            </div>
            <div class="card-body">
                <!-- Message Text Area -->
                <div class="mb-3">
                    <label class="form-label">消息内容</label>
                    <textarea class="form-control" id="messageText" rows="10" placeholder="输入你的消息...

Markdown格式示例：
**粗体** _斜体_ [链接](https://example.com)"></textarea>
                    <small class="text-muted">
                        支持 Markdown 或 HTML 格式
                    </small>
                </div>

                <!-- Inline Buttons -->
                <div class="mb-3">
                    <label class="form-label">
                        内联按钮
                        <button class="btn btn-sm btn-success" onclick="addButton()">
                            <i class="bi bi-plus-circle"></i> 添加按钮
                        </button>
                    </label>
                    <div id="buttonsList"></div>
                </div>

                <!-- Admin ID for Test Send -->
                <div class="mb-3">
                    <label class="form-label">管理员 Telegram ID (用于测试发送)</label>
                    <input type="number" class="form-control" id="adminId" placeholder="输入你的 Telegram 用户 ID">
                    <small class="text-muted">输入你自己的 Telegram ID 以接收测试消息</small>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-info" onclick="saveDraft()">
                        <i class="bi bi-floppy"></i> 保存草稿
                    </button>
                    <button class="btn btn-warning" onclick="testSend()">
                        <i class="bi bi-send-check"></i> 测试发送 (发送给自己)
                    </button>
                    <button class="btn btn-primary" onclick="showBroadcastConfirmation()">
                        <i class="bi bi-broadcast"></i> 发送广播
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel: Preview -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <i class="bi bi-eye"></i> 消息预览
            </div>
            <div class="card-body">
                <div id="messagePreview" class="telegram-preview p-3 border rounded bg-light">
                    <div class="text-muted text-center">
                        <i class="bi bi-chat-left-text fs-1"></i><br>
                        在左侧输入消息以查看预览
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> 确认发送广播
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2"><strong>你即将发送广播消息给：</strong></p>
                <p class="text-center fs-3 text-primary mb-3">
                    <strong id="confirmUserCount">0</strong> 个用户
                </p>
                <p class="text-muted">请确认消息内容和筛选条件正确，此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="sendBroadcast()">确认发送</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-broadcast"></i> 正在发送广播...
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar">0%</div>
                </div>
                <div id="progressStatus" class="text-center text-muted">
                    准备发送...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="resultHeader">
                <h5 class="modal-title" id="resultTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Initialize
let currentParseMode = 'Markdown';
let buttons = [];

// Update user count on load and filter change
document.addEventListener('DOMContentLoaded', function() {
    updateUserCount();
    loadDrafts();

    // Attach event listeners to all filter controls
    document.querySelectorAll('.filter-checkbox, #min-balance, #max-balance, #last-active-after, #last-active-before, #purchase-filter').forEach(element => {
        element.addEventListener('change', updateUserCount);
    });

    // Update preview on message change
    document.getElementById('messageText').addEventListener('input', updatePreview);
});

function updateUserCount() {
    const filters = getFilters();

    fetch('/api/users/count', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({filters: filters})
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('userCount').textContent = data.count;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('userCount').textContent = 'Error';
    });
}

function getFilters() {
    const vipTiers = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);

    const filters = {};

    if (vipTiers.length > 0 && vipTiers.length < 3) {
        filters.vip_tiers = vipTiers;
    }

    const minBalance = document.getElementById('min-balance').value;
    const maxBalance = document.getElementById('max-balance').value;
    if (minBalance) filters.min_balance = parseFloat(minBalance);
    if (maxBalance) filters.max_balance = parseFloat(maxBalance);

    const lastActiveAfter = document.getElementById('last-active-after').value;
    const lastActiveBefore = document.getElementById('last-active-before').value;
    if (lastActiveAfter) filters.last_active_after = lastActiveAfter;
    if (lastActiveBefore) filters.last_active_before = lastActiveBefore;

    const purchaseFilter = document.getElementById('purchase-filter').value;
    if (purchaseFilter === 'paid') filters.has_purchased = true;
    else if (purchaseFilter === 'free') filters.has_purchased = false;

    return Object.keys(filters).length > 0 ? filters : null;
}

function resetFilters() {
    document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = true);
    document.getElementById('min-balance').value = '';
    document.getElementById('max-balance').value = '';
    document.getElementById('last-active-after').value = '';
    document.getElementById('last-active-before').value = '';
    document.getElementById('purchase-filter').value = 'all';
    updateUserCount();
}

function setParseMode(mode) {
    currentParseMode = mode;
    document.getElementById('markdownBtn').classList.toggle('active', mode === 'Markdown');
    document.getElementById('htmlBtn').classList.toggle('active', mode === 'HTML');
    updatePreview();
}

function updatePreview() {
    const message = document.getElementById('messageText').value;
    const preview = document.getElementById('messagePreview');

    if (!message) {
        preview.innerHTML = `<div class="text-muted text-center">
            <i class="bi bi-chat-left-text fs-1"></i><br>
            在左侧输入消息以查看预览
        </div>`;
        return;
    }

    // Simple Markdown to HTML conversion
    let html = message;
    if (currentParseMode === 'Markdown') {
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/_(.+?)_/g, '<em>$1</em>');
        html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2">$1</a>');
        html = html.replace(/\n/g, '<br>');
    }

    preview.innerHTML = html;

    // Add buttons preview
    if (buttons.length > 0) {
        const buttonsHtml = buttons.map(btn =>
            `<a href="${btn.url}" class="btn btn-sm btn-outline-primary me-2 mb-2" target="_blank">${btn.text}</a>`
        ).join('');
        preview.innerHTML += `<div class="mt-3">${buttonsHtml}</div>`;
    }
}

function addButton() {
    const text = prompt('按钮文字:');
    if (!text) return;

    const url = prompt('按钮链接 (URL):');
    if (!url) return;

    buttons.push({text, url});
    renderButtons();
    updatePreview();
}

function renderButtons() {
    const buttonsList = document.getElementById('buttonsList');
    if (buttons.length === 0) {
        buttonsList.innerHTML = '';
        return;
    }

    buttonsList.innerHTML = buttons.map((btn, index) => `
        <div class="input-group input-group-sm mb-2">
            <input type="text" class="form-control" value="${btn.text}" readonly>
            <input type="text" class="form-control" value="${btn.url}" readonly>
            <button class="btn btn-danger" onclick="removeButton(${index})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `).join('');
}

function removeButton(index) {
    buttons.splice(index, 1);
    renderButtons();
    updatePreview();
}

function saveDraft() {
    const message = document.getElementById('messageText').value;
    if (!message) {
        alert('请先输入消息内容');
        return;
    }

    const draftName = prompt('草稿名称:');
    if (!draftName) return;

    const draftData = {
        name: draftName,
        message: message,
        parse_mode: currentParseMode,
        buttons: buttons,
        filters: getFilters()
    };

    fetch('/api/drafts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(draftData)
    })
    .then(response => response.json())
    .then(() => {
        alert('草稿已保存');
        loadDrafts();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('保存失败');
    });
}

function loadDrafts() {
    fetch('/api/drafts')
        .then(response => response.json())
        .then(drafts => {
            const draftsList = document.getElementById('draftsList');

            if (drafts.length === 0) {
                draftsList.innerHTML = `<div class="text-center text-muted py-3">
                    <i class="bi bi-inbox"></i><br>
                    暂无草稿
                </div>`;
                return;
            }

            draftsList.innerHTML = drafts.map(draft => `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <small class="text-truncate" style="cursor: pointer;" onclick='loadDraft(${JSON.stringify(draft)})'>
                        ${draft.name}
                    </small>
                    <button class="btn btn-sm btn-danger" onclick="deleteDraft(${draft.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
        })
        .catch(error => console.error('Error:', error));
}

function loadDraft(draft) {
    document.getElementById('messageText').value = draft.message;
    currentParseMode = draft.parse_mode || 'Markdown';
    setParseMode(currentParseMode);
    buttons = draft.buttons || [];
    renderButtons();
    updatePreview();
}

function deleteDraft(draftId) {
    if (!confirm('确定删除此草稿？')) return;

    fetch(`/api/drafts/${draftId}`, {method: 'DELETE'})
        .then(() => loadDrafts())
        .catch(error => console.error('Error:', error));
}

function testSend() {
    const message = document.getElementById('messageText').value;
    const adminId = document.getElementById('adminId').value;

    if (!message) {
        alert('请先输入消息内容');
        return;
    }

    if (!adminId) {
        alert('请输入你的 Telegram ID');
        return;
    }

    fetch('/api/broadcast/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            message: message,
            parse_mode: currentParseMode,
            buttons: buttons.length > 0 ? [buttons] : null,
            admin_id: parseInt(adminId)
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.successful > 0) {
            alert('测试消息已发送！请检查你的 Telegram');
        } else {
            alert('发送失败: ' + JSON.stringify(result));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('发送失败');
    });
}

function showBroadcastConfirmation() {
    const message = document.getElementById('messageText').value;
    if (!message) {
        alert('请先输入消息内容');
        return;
    }

    const userCount = document.getElementById('userCount').textContent;
    document.getElementById('confirmUserCount').textContent = userCount;

    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    confirmModal.show();
}

function sendBroadcast() {
    const message = document.getElementById('messageText').value;
    const filters = getFilters();

    // Close confirmation modal
    const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
    confirmModal.hide();

    // Show progress modal
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    progressModal.show();

    fetch('/api/broadcast/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            message: message,
            parse_mode: currentParseMode,
            filters: filters,
            buttons: buttons.length > 0 ? [buttons] : null
        })
    })
    .then(response => response.json())
    .then(result => {
        // Hide progress modal
        progressModal.hide();

        // Show result modal
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        const resultHeader = document.getElementById('resultHeader');
        const resultBody = document.getElementById('resultBody');

        if (result.successful > 0) {
            resultHeader.className = 'modal-header bg-success text-white';
            document.getElementById('resultTitle').innerHTML = '<i class="bi bi-check-circle"></i> 发送成功';
            resultBody.innerHTML = `
                <div class="text-center">
                    <p class="fs-4 mb-3">成功发送: <strong class="text-success">${result.successful}</strong></p>
                    <p class="fs-4 mb-3">发送失败: <strong class="text-danger">${result.failed}</strong></p>
                    ${result.failed > 0 ? `<p class="text-muted">失败的用户可能已屏蔽机器人</p>` : ''}
                </div>
            `;
        } else {
            resultHeader.className = 'modal-header bg-danger text-white';
            document.getElementById('resultTitle').innerHTML = '<i class="bi bi-x-circle"></i> 发送失败';
            resultBody.innerHTML = '<p>所有消息发送失败，请检查配置</p>';
        }

        resultModal.show();
    })
    .catch(error => {
        progressModal.hide();
        console.error('Error:', error);
        alert('发送失败: ' + error);
    });
}
</script>
{% endblock %}
